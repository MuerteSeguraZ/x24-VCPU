#include <iostream>
#include <vector>
#include <string>
#include "vcpu.cpp"

using namespace std;

int main() {
    try {
        CPU cpu;
        
        vector<string> crypto_test = {
            "# New Cryptographic Instructions Test Suite",
            "# Tests AESENCLAST, AESDECLAST, SHA256RNDS2, SHA256MSG2,",
            "# SHA1RNDS4, SHA1NEXTE, SHA1MSG1, SHA1MSG2, ADCX, ADOX",
            "",
            "PRINT \"=\"",
            "PRINT \"=== New Crypto Instructions Test ===\"",
            "PRINT \"=\"",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 1: AESENCLAST - AES Final Encryption Round",
            "# ============================================",
            "PRINT \"Test 1: AESENCLAST - AES Final Encryption Round\"",
            "",
            "# Setup plaintext block (128 bits = 16 bytes in r16_0-r16_7)",
            "HPUT 0x1100 r16_0",
            "HPUT 0x3322 r16_1",
            "HPUT 0x5544 r16_2",
            "HPUT 0x7766 r16_3",
            "HPUT 0x9988 r16_4",
            "HPUT 0xBBAA r16_5",
            "HPUT 0xDDCC r16_6",
            "HPUT 0xFFEE r16_7",
            "",
            "# Setup final round key",
            "HPUT 0x0F0E r16_8",
            "HPUT 0x0D0C r16_9",
            "HPUT 0x0B0A r16_10",
            "HPUT 0x0908 r16_11",
            "HPUT 0x0706 r16_12",
            "HPUT 0x0504 r16_13",
            "HPUT 0x0302 r16_14",
            "HPUT 0x0100 r16_15",
            "",
            "PRINT \"Before AESENCLAST - r16_0:\"",
            "PRINT r16_0",
            "PRINT \"Before AESENCLAST - r16_1:\"",
            "PRINT r16_1",
            "",
            "# Perform final AES encryption round (no MixColumns)",
            "AESENCLAST r16_8 r16_0",
            "",
            "PRINT \"After AESENCLAST - r16_0:\"",
            "PRINT r16_0",
            "PRINT \"After AESENCLAST - r16_1:\"",
            "PRINT r16_1",
            "PRINT \"After AESENCLAST - r16_2:\"",
            "PRINT r16_2",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 2: AESDECLAST - AES Final Decryption Round",
            "# ============================================",
            "PRINT \"Test 2: AESDECLAST - AES Final Decryption Round\"",
            "",
            "# Save encrypted state",
            "MOV r16_0 r16_16",
            "MOV r16_1 r16_17",
            "MOV r16_2 r16_18",
            "MOV r16_3 r16_19",
            "",
            "PRINT \"Encrypted state saved to r16_16-r16_19\"",
            "PRINT \"Before AESDECLAST - r16_0:\"",
            "PRINT r16_0",
            "",
            "# Decrypt using same key (final round)",
            "AESDECLAST r16_8 r16_0",
            "",
            "PRINT \"After AESDECLAST - r16_0:\"",
            "PRINT r16_0",
            "PRINT \"After AESDECLAST - r16_1:\"",
            "PRINT r16_1",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 3: SHA256RNDS2 - SHA-256 2 Rounds",
            "# ============================================",
            "PRINT \"Test 3: SHA256RNDS2 - SHA-256 Compression (2 rounds)\"",
            "",
            "# Setup SHA-256 state (8 x 32-bit = 16 bytes using 8 r16)",
            "# Initial hash values (first 32 bits of fractional parts of sqrt of first 8 primes)",
            "HPUT 0x9b05 r16_0  # H0 low",
            "HPUT 0x6a09 r16_1  # H0 high",
            "HPUT 0xe667 r16_2  # H1 low",
            "HPUT 0xbb67 r16_3  # H1 high",
            "HPUT 0xa54f r16_4  # H2 low",
            "HPUT 0x3c6e r16_5  # H2 high",
            "HPUT 0x1f83 r16_6  # H3 low",
            "HPUT 0xa54f r16_7  # H3 high",
            "",
            "# Setup message schedule words (W0, W1)",
            "HPUT 0x0001 r16_8  # W0 low",
            "HPUT 0x0203 r16_9  # W0 high",
            "HPUT 0x0405 r16_10 # W1 low",
            "HPUT 0x0607 r16_11 # W1 high",
            "",
            "# Setup K constants",
            "HPUT 0x2de6 r16_12 # K0 low",
            "HPUT 0x428a r16_13 # K0 high",
            "HPUT 0x442f r16_14 # K1 low",
            "HPUT 0x7137 r16_15 # K1 high",
            "",
            "PRINT \"SHA-256 state before RNDS2:\"",
            "PRINT \"  r16_0 (H0 low):\"",
            "PRINT r16_0",
            "PRINT \"  r16_2 (H1 low):\"",
            "PRINT r16_2",
            "",
            "# Perform 2 rounds of SHA-256",
            "SHA256RNDS2 r16_12 r16_8 r16_0",
            "",
            "PRINT \"SHA-256 state after RNDS2:\"",
            "PRINT \"  r16_0 (H0 low):\"",
            "PRINT r16_0",
            "PRINT \"  r16_2 (H1 low):\"",
            "PRINT r16_2",
            "PRINT \"  r16_4 (H2 low):\"",
            "PRINT r16_4",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 4: SHA256MSG2 - SHA-256 Message Schedule Step 2",
            "# ============================================",
            "PRINT \"Test 4: SHA256MSG2 - SHA-256 Message Schedule\"",
            "",
            "# Setup message schedule data",
            "HPUT 0x1234 r16_0",
            "HPUT 0x5678 r16_1",
            "HPUT 0x9ABC r16_2",
            "HPUT 0xDEF0 r16_3",
            "",
            "HPUT 0xAAAA r16_4",
            "HPUT 0xBBBB r16_5",
            "HPUT 0xCCCC r16_6",
            "HPUT 0xDDDD r16_7",
            "",
            "PRINT \"Before SHA256MSG2:\"",
            "PRINT \"  r16_0:\"",
            "PRINT r16_0",
            "PRINT \"  r16_4 (source):\"",
            "PRINT r16_4",
            "",
            "SHA256MSG2 r16_4 r16_0",
            "",
            "PRINT \"After SHA256MSG2:\"",
            "PRINT \"  r16_0:\"",
            "PRINT r16_0",
            "PRINT \"  r16_1:\"",
            "PRINT r16_1",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 5: SHA1RNDS4 - SHA-1 4 Rounds",
            "# ============================================",
            "PRINT \"Test 5: SHA1RNDS4 - SHA-1 Compression (4 rounds)\"",
            "",
            "# Setup SHA-1 state (5 x 32-bit values)",
            "HPUT 0xC3D2 r16_0  # A low",
            "HPUT 0x6745 r16_1  # A high",
            "HPUT 0xE1F0 r16_2  # B low",
            "HPUT 0xEFCD r16_3  # B high",
            "HPUT 0x10F2 r16_4  # C low",
            "HPUT 0x98BA r16_5  # C high",
            "HPUT 0x5476 r16_6  # D low",
            "HPUT 0x1032 r16_7  # D high",
            "",
            "# Setup message words W0-W3",
            "HPUT 0x0100 r16_8",
            "HPUT 0x0302 r16_9",
            "HPUT 0x0504 r16_10",
            "HPUT 0x0706 r16_11",
            "HPUT 0x0908 r16_12",
            "HPUT 0x0B0A r16_13",
            "",
            "# E value",
            "HPUT 0xC3D2 r16_14",
            "HPUT 0x6745 r16_15",
            "",
            "PRINT \"SHA-1 state before RNDS4:\"",
            "PRINT \"  r16_0 (A low):\"",
            "PRINT r16_0",
            "PRINT \"  r16_2 (B low):\"",
            "PRINT r16_2",
            "",
            "# Perform 4 rounds (func=0 for rounds 0-19)",
            "LPUT 0 r8_0",
            "SHA1RNDS4 r8_0 r16_8 r16_0",
            "",
            "PRINT \"SHA-1 state after RNDS4 (func=0):\"",
            "PRINT \"  r16_0 (A low):\"",
            "PRINT r16_0",
            "PRINT \"  r16_2 (B low):\"",
            "PRINT r16_2",
            "PRINT \"  r16_4 (C low):\"",
            "PRINT r16_4",
            "PRINT \"\"",
            "",
            "# Test with different function",
            "PRINT \"Testing SHA1RNDS4 with func=1...\"",
            "LPUT 1 r8_0",
            "SHA1RNDS4 r8_0 r16_8 r16_0",
            "PRINT \"  After func=1, r16_0:\"",
            "PRINT r16_0",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 6: SHA1NEXTE - SHA-1 Next E Value",
            "# ============================================",
            "PRINT \"Test 6: SHA1NEXTE - Calculate Next E\"",
            "",
            "# Setup E value in source",
            "HPUT 0x1234 r16_0",
            "HPUT 0x5678 r16_1",
            "",
            "# Setup state0 in destination",
            "HPUT 0xABCD r16_2",
            "HPUT 0xEF01 r16_3",
            "",
            "PRINT \"Before SHA1NEXTE:\"",
            "PRINT \"  Source E (r16_0):\"",
            "PRINT r16_0",
            "PRINT \"  Dest state0 (r16_2):\"",
            "PRINT r16_2",
            "",
            "SHA1NEXTE r16_0 r16_2",
            "",
            "PRINT \"After SHA1NEXTE:\"",
            "PRINT \"  New E (r16_2):\"",
            "PRINT r16_2",
            "PRINT \"  r16_3:\"",
            "PRINT r16_3",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 7: SHA1MSG1 - SHA-1 Message Schedule Step 1",
            "# ============================================",
            "PRINT \"Test 7: SHA1MSG1 - SHA-1 Message Schedule (Step 1)\"",
            "",
            "# Setup message data",
            "HPUT 0x1111 r16_0",
            "HPUT 0x2222 r16_1",
            "HPUT 0x3333 r16_2",
            "HPUT 0x4444 r16_3",
            "",
            "HPUT 0x5555 r16_4",
            "HPUT 0x6666 r16_5",
            "",
            "PRINT \"Before SHA1MSG1:\"",
            "PRINT \"  Dest (r16_0):\"",
            "PRINT r16_0",
            "PRINT \"  Source (r16_4):\"",
            "PRINT r16_4",
            "",
            "SHA1MSG1 r16_4 r16_0",
            "",
            "PRINT \"After SHA1MSG1:\"",
            "PRINT \"  r16_0:\"",
            "PRINT r16_0",
            "PRINT \"  r16_1:\"",
            "PRINT r16_1",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 8: SHA1MSG2 - SHA-1 Message Schedule Step 2",
            "# ============================================",
            "PRINT \"Test 8: SHA1MSG2 - SHA-1 Message Schedule (Step 2)\"",
            "",
            "# Setup data",
            "HPUT 0x8888 r16_0",
            "HPUT 0x9999 r16_1",
            "",
            "HPUT 0xAAAA r16_2",
            "HPUT 0xBBBB r16_3",
            "",
            "PRINT \"Before SHA1MSG2:\"",
            "PRINT \"  Dest (r16_0):\"",
            "PRINT r16_0",
            "PRINT \"  Source (r16_2):\"",
            "PRINT r16_2",
            "",
            "SHA1MSG2 r16_2 r16_0",
            "",
            "PRINT \"After SHA1MSG2 (with rotation):\"",
            "PRINT \"  r16_0:\"",
            "PRINT r16_0",
            "PRINT \"  r16_1:\"",
            "PRINT r16_1",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 9: ADCX - Add with Carry (CF only)",
            "# ============================================",
            "PRINT \"Test 9: ADCX - Add with Carry Flag\"",
            "",
            "# Clear carry flag",
            "CLC",
            "",
            "# Test 1: Simple addition without initial carry",
            "HPUT 0x8000 r16_0",
            "HPUT 0x8000 r16_1",
            "",
            "PRINT \"Test without initial carry:\"",
            "PRINT \"  r16_0:\"",
            "PRINT r16_0",
            "PRINT \"  r16_1 (before):\"",
            "PRINT r16_1",
            "",
            "ADCX r16_0 r16_1",
            "",
            "PRINT \"  r16_1 (after ADCX):\"",
            "PRINT r16_1",
            "PRINT \"  Carry flag should be set (result > 0xFFFF)\"",
            "PRINT \"\"",
            "",
            "# Test 2: Addition with carry",
            "PRINT \"Test with carry flag set:\"",
            "HPUT 0x0001 r16_2",
            "HPUT 0x0002 r16_3",
            "",
            "PRINT \"  r16_2:\"",
            "PRINT r16_2",
            "PRINT \"  r16_3 (before):\"",
            "PRINT r16_3",
            "PRINT \"  CF is set from previous operation\"",
            "",
            "ADCX r16_2 r16_3",
            "",
            "PRINT \"  r16_3 (after ADCX with CF):\"",
            "PRINT r16_3",
            "PRINT \"  Result should be 0x0004 (0x0002 + 0x0001 + 1)\"",
            "PRINT \"\"",
            "",
            "# Test 3: 8-bit ADCX",
            "CLC",
            "LPUT 0xFF r8_0",
            "LPUT 0x01 r8_1",
            "",
            "PRINT \"8-bit ADCX test:\"",
            "PRINT \"  r8_0:\"",
            "PRINT r8_0",
            "PRINT \"  r8_1 (before):\"",
            "PRINT r8_1",
            "",
            "ADCX r8_0 r8_1",
            "",
            "PRINT \"  r8_1 (after):\"",
            "PRINT r8_1",
            "PRINT \"  Should overflow to 0x00 with CF=1\"",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 10: ADOX - Add with Overflow (OF only)",
            "# ============================================",
            "PRINT \"Test 10: ADOX - Add with Overflow Flag\"",
            "",
            "# Clear overflow flag (do a simple operation)",
            "LPUT 1 r8_10",
            "LPUT 1 r8_11",
            "LUADD r8_10 r8_11",
            "",
            "# Test 1: Simple addition",
            "HPUT 0x7FFF r16_4",
            "HPUT 0x7FFF r16_5",
            "",
            "PRINT \"Test without initial overflow:\"",
            "PRINT \"  r16_4:\"",
            "PRINT r16_4",
            "PRINT \"  r16_5 (before):\"",
            "PRINT r16_5",
            "",
            "ADOX r16_4 r16_5",
            "",
            "PRINT \"  r16_5 (after ADOX):\"",
            "PRINT r16_5",
            "PRINT \"  Overflow flag should be set\"",
            "PRINT \"\"",
            "",
            "# Test 2: Addition with overflow flag",
            "PRINT \"Test with overflow flag set:\"",
            "HPUT 0x0010 r16_6",
            "HPUT 0x0020 r16_7",
            "",
            "PRINT \"  r16_6:\"",
            "PRINT r16_6",
            "PRINT \"  r16_7 (before):\"",
            "PRINT r16_7",
            "",
            "ADOX r16_6 r16_7",
            "",
            "PRINT \"  r16_7 (after ADOX with OF):\"",
            "PRINT r16_7",
            "PRINT \"  Result includes OF from previous\"",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 11: ADCX and ADOX Together (Multi-Precision)",
            "# ============================================",
            "PRINT \"Test 11: ADCX + ADOX for Multi-Precision Arithmetic\"",
            "",
            "# Clear both flags",
            "CLC",
            "LPUT 1 r8_20",
            "LPUT 1 r8_21",
            "LUADD r8_20 r8_21",
            "",
            "# Simulate 64-bit addition using 4 x 16-bit registers",
            "# Operand A: r16_0:r16_1:r16_2:r16_3",
            "# Operand B: r16_4:r16_5:r16_6:r16_7",
            "# Result in B",
            "",
            "HPUT 0xFFFF r16_0",
            "HPUT 0xFFFF r16_1",
            "HPUT 0x0000 r16_2",
            "HPUT 0x0001 r16_3",
            "",
            "HPUT 0x0001 r16_4",
            "HPUT 0x0001 r16_5",
            "HPUT 0x0001 r16_6",
            "HPUT 0x0001 r16_7",
            "",
            "PRINT \"64-bit addition (using carries):\"",
            "PRINT \"  Operand A (r16_0-r16_3): 0x0001 0000 FFFF FFFF\"",
            "PRINT \"  Operand B (r16_4-r16_7): 0x0001 0001 0001 0001\"",
            "",
            "# Add with carry propagation",
            "ADCX r16_0 r16_4  # LSW",
            "ADCX r16_1 r16_5  # Propagate carry",
            "ADCX r16_2 r16_6  # Propagate carry",
            "ADCX r16_3 r16_7  # MSW",
            "",
            "PRINT \"  Result (r16_4-r16_7):\"",
            "PRINT \"    r16_4 (LSW):\"",
            "PRINT r16_4",
            "PRINT \"    r16_5:\"",
            "PRINT r16_5",
            "PRINT \"    r16_6:\"",
            "PRINT r16_6",
            "PRINT \"    r16_7 (MSW):\"",
            "PRINT r16_7",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 12: Complete SHA-256 Round Simulation",
            "# ============================================",
            "PRINT \"Test 12: Complete SHA-256 Round Sequence\"",
            "PRINT \"(MSG1 -> MSG2 -> RNDS2)\"",
            "",
            "# Initialize message schedule",
            "HPUT 0x0001 r16_0",
            "HPUT 0x0002 r16_1",
            "",
            "HPUT 0x0003 r16_4",
            "HPUT 0x0004 r16_5",
            "",
            "PRINT \"Step 1: SHA256MSG1\"",
            "SHA256MSG1 r16_4 r16_0",
            "PRINT \"  After MSG1, r16_0:\"",
            "PRINT r16_0",
            "",
            "PRINT \"Step 2: SHA256MSG2\"",
            "SHA256MSG2 r16_4 r16_0",
            "PRINT \"  After MSG2, r16_0:\"",
            "PRINT r16_0",
            "",
            "# Setup state for RNDS2",
            "HPUT 0x9b05 r16_8",
            "HPUT 0x6a09 r16_9",
            "",
            "# Setup K+W",
            "HPUT 0x2de6 r16_12",
            "HPUT 0x428a r16_13",
            "",
            "PRINT \"Step 3: SHA256RNDS2\"",
            "SHA256RNDS2 r16_12 r16_0 r16_8",
            "PRINT \"  After RNDS2, state r16_8:\"",
            "PRINT r16_8",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 13: Complete SHA-1 Round Simulation",
            "# ============================================",
            "PRINT \"Test 13: Complete SHA-1 Round Sequence\"",
            "PRINT \"(MSG1 -> MSG2 -> NEXTE -> RNDS4)\"",
            "",
            "# Message schedule",
            "HPUT 0x1000 r16_0",
            "HPUT 0x2000 r16_1",
            "",
            "HPUT 0x3000 r16_2",
            "HPUT 0x4000 r16_3",
            "",
            "PRINT \"Step 1: SHA1MSG1\"",
            "SHA1MSG1 r16_2 r16_0",
            "PRINT \"  After MSG1, r16_0:\"",
            "PRINT r16_0",
            "",
            "PRINT \"Step 2: SHA1MSG2\"",
            "SHA1MSG2 r16_2 r16_0",
            "PRINT \"  After MSG2, r16_0:\"",
            "PRINT r16_0",
            "",
            "# E calculation",
            "HPUT 0xC3D2 r16_4",
            "HPUT 0x6745 r16_5",
            "",
            "HPUT 0x1234 r16_6",
            "HPUT 0x5678 r16_7",
            "",
            "PRINT \"Step 3: SHA1NEXTE\"",
            "SHA1NEXTE r16_4 r16_6",
            "PRINT \"  After NEXTE, r16_6:\"",
            "PRINT r16_6",
            "",
            "# Setup for RNDS4",
            "HPUT 0xC3D2 r16_8",
            "HPUT 0x6745 r16_9",
            "",
            "PRINT \"Step 4: SHA1RNDS4\"",
            "LPUT 0 r8_0",
            "SHA1RNDS4 r8_0 r16_0 r16_8",
            "PRINT \"  After RNDS4, r16_8:\"",
            "PRINT r16_8",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Summary",
            "# ============================================",
            "PRINT \"=\"",
            "PRINT \"=== All New Crypto Tests Completed! ===\"",
            "PRINT \"=\"",
            "PRINT \"\"",
            "PRINT \"Tests performed:\"",
            "PRINT \"  [✓] AESENCLAST - AES final encryption round\"",
            "PRINT \"  [✓] AESDECLAST - AES final decryption round\"",
            "PRINT \"  [✓] SHA256RNDS2 - SHA-256 2 rounds compression\"",
            "PRINT \"  [✓] SHA256MSG2 - SHA-256 message schedule step 2\"",
            "PRINT \"  [✓] SHA1RNDS4 - SHA-1 4 rounds compression\"",
            "PRINT \"  [✓] SHA1NEXTE - SHA-1 next E calculation\"",
            "PRINT \"  [✓] SHA1MSG1 - SHA-1 message schedule step 1\"",
            "PRINT \"  [✓] SHA1MSG2 - SHA-1 message schedule step 2\"",
            "PRINT \"  [✓] ADCX - Add with carry (CF only)\"",
            "PRINT \"  [✓] ADOX - Add with overflow (OF only)\"",
            "PRINT \"  [✓] Multi-precision arithmetic with ADCX\"",
            "PRINT \"  [✓] Complete SHA-256 round sequence\"",
            "PRINT \"  [✓] Complete SHA-1 round sequence\"",
            "PRINT \"\"",
            "PRINT \"All new cryptographic instructions working!\"",
            "",
            "QUIT",
        };
        
        cpu.load_program_lines(crypto_test);
        cpu.run();
        
        cout << "\n=== New crypto instructions test completed successfully! ===\n";
        
    } catch (const exception& e) {
        cerr << "Error: " << e.what() << endl;
        return 1;
    }
    
    return 0;
}