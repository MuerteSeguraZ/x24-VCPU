#include <iostream>
#include <vector>
#include <string>
#include "vcpu.cpp"

using namespace std;

int main() {
    try {
        CPU cpu;
        
        vector<string> test_program = {
    "# Interrupt System Test Program",
    "# Tests: SETVEC, INT, TRIGGER, STI, CLI, IRET, HLT",
    "",
    "# Setup interrupt vector table",
    "HPUT 100 r16_0",
    "SETVEC 0 timer_handler",
    "",
    "HPUT 200 r16_0",
    "SETVEC 1 keyboard_handler",
    "",
    "HPUT 300 r16_0",
    "SETVEC 32 error_handler",
    "",
    "# Initialize test variables",
    "LPUT 0 r8_0           # Counter for timer interrupts",
    "LPUT 0 r8_1           # Counter for keyboard interrupts",
    "LPUT 0 r8_2           # Error flag",
    "",
    "# Test 1: Software interrupt (INT instruction)",
    "PRINT \"Test 1: Software interrupt\"",
    "LPUT 5 r8_3",
    "INT 0",
    "PRINT \"Timer counter after INT 0:\"",
    "PRINT r8_0",
    "LCMP 1 r8_0",
    "JNE test1_fail",
    "",
    "# Test 2: Queued interrupt (TRIGGER)",
    "PRINT \"\\nTest 2: Queued interrupt\"",
    "TRIGGER 1",
    "NOP",
    "PRINT \"Keyboard counter after TRIGGER 1:\"",
    "PRINT r8_1",
    "LCMP 1 r8_1",
    "JNE test2_fail",
    "",
    "# Test 3: Multiple queued interrupts",
    "PRINT \"\\nTest 3: Multiple interrupts\"",
    "TRIGGER 0",
    "TRIGGER 1",
    "TRIGGER 0",
    "NOP",
    "PRINT \"Timer counter (should be 3):\"",
    "PRINT r8_0",
    "PRINT \"Keyboard counter (should be 2):\"",
    "PRINT r8_1",
    "LCMP 3 r8_0",
    "JNE test3_fail",
    "LCMP 2 r8_1",
    "JNE test3_fail",
    "",
    "# Test 4: CLI/STI (interrupt masking)",
    "PRINT \"\\nTest 4: Interrupt masking\"",
    "CLI",
    "TRIGGER 0",
    "TRIGGER 1",
    "NOP",
    "NOP",
    "PRINT \"After CLI - Timer counter (should still be 3):\"",
    "PRINT r8_0",
    "PRINT \"After CLI - Keyboard counter (should still be 2):\"",
    "PRINT r8_1",
    "STI",
    "NOP",
    "PRINT \"After STI - Timer counter (should be 4):\"",
    "PRINT r8_0",
    "PRINT \"After STI - Keyboard counter (should be 3):\"",
    "PRINT r8_1",
    "",
    "# Test 5: Interrupt during interrupt (nested)",
    "PRINT \"\\nTest 5: Nested interrupts\"",
    "LPUT 10 r8_4",
    "INT 32",
    "PRINT \"Error flag (should be 1):\"",
    "PRINT r8_2",
    "PRINT \"Timer counter after nested (should be 5):\"",
    "PRINT r8_0",
    "",
    "# Test 6: HLT with pending interrupt",
    "PRINT \"\\nTest 6: HLT with interrupt\"",
    "CLI",           // Disable interrupts so TRIGGER doesn't fire immediately
    "TRIGGER 0",     // Queue the interrupt
    "HLT",           // HLT will process it regardless of CLI
    "PRINT \"Timer counter after HLT (should be 6):\"",
    "PRINT r8_0",
    "STI",           // Re-enable for any remaining tests
    "# Test 7: Return address preservation",
    "PRINT \"\\nTest 7: Return address test\"",
    "LPUT 99 r8_5",
    "CALL interrupt_test_func",
    "PRINT \"Value after CALL with interrupt (should be 100):\"",
    "PRINT r8_5",
    "",
    "# Test 8: Flag preservation",
    "PRINT \"\\nTest 8: Flag preservation\"",
    "LPUT 5 r8_6",
    "LPUT 5 r8_7",
    "LCMP r8_6 r8_7",   // Compare 5 to 5: ZF=1
    "INT 1",
    "JE flags_ok",       // Should jump because ZF=1 (equal)
    "PRINT \"FAIL: Flags not preserved\"",
    "JMP test_end",
    "",
    "flags_ok:",
    "PRINT \"SUCCESS: All interrupt tests passed!\"",
    "JMP test_end",
    "",
    "# Handlers",
    "timer_handler:",
    "    PRINT \"  [Timer handler executed]\"",
    "    LPUT 1 r8_10",
    "    LUADD r8_10 r8_0",
    "    IRET",
    "",
    "keyboard_handler:",
    "    PRINT \"  [Keyboard handler executed]\"",
    "    LPUT 1 r8_10",
    "    LUADD r8_10 r8_1",
    "    IRET",
    "",
    "error_handler:",
    "    PRINT \"  [Error handler - triggering nested interrupt]\"",
    "    LPUT 1 r8_2",
    "    STI",
    "    TRIGGER 0",
    "    NOP",
    "    CLI",
    "    IRET",
    "",
    "interrupt_test_func:",
    "    LPUT 1 r8_10",
    "    LUADD r8_10 r8_5",
    "    TRIGGER 1",
    "    NOP",
    "    RET",
    "",
    "# Test failure handlers",
    "test1_fail:",
    "    PRINT \"FAIL: Test 1 - Software interrupt\"",
    "    JMP test_end",
    "",
    "test2_fail:",
    "    PRINT \"FAIL: Test 2 - Queued interrupt\"",
    "    JMP test_end",
    "",
    "test3_fail:",
    "    PRINT \"FAIL: Test 3 - Multiple interrupts\"",
    "    JMP test_end",
    "",
    "test_end:",
    "    PRINT \"\\n=== Interrupt test complete ===\"",
    "    QUIT"
};
        
        cpu.load_program_lines(test_program);
        cpu.run();
        
        cout << "\n=== Test completed successfully! ===\n";
        
    } catch (const exception& e) {
        cerr << "Error: " << e.what() << endl;
        return 1;
    }
    
    return 0;
}