#include <iostream>
#include <vector>
#include <string>
#include "vcpu.cpp"

using namespace std;

int main() {
    try {
        CPU cpu;
        
        vector<string> hardware_interrupt_test = {
            "# Hardware Interrupt Test",
            "",
            "# ============================================",
            "# Setup: Configure interrupt handlers",
            "# ============================================",
            "",
            "# Set interrupt priorities",
            "SETPRI 0 20     # PIT (timer) - high priority",
            "SETPRI 1 15     # Keyboard - medium-high",
            "SETPRI 4 10     # Serial - medium",
            "SETPRI 14 12    # Disk - medium",
            "SETPRI 8 8      # RTC - medium-low",
            "SETPRI 10 5     # Custom device - low",
            "",
            "# Register interrupt handlers",
            "SETVEC 0 timer_handler",
            "SETVEC 1 keyboard_handler",
            "SETVEC 4 serial_handler",
            "SETVEC 14 disk_handler",
            "SETVEC 8 rtc_handler",
            "SETVEC 10 custom_device_handler",
            "",
            "PRINT \"Interrupt handlers registered\"",
            "PRINT \"\"",
            "",
            "# Enable interrupts",
            "STI",
            "",
            "# ============================================",
            "# Test 1: PIT (Programmable Interval Timer)",
            "# ============================================",
            "PRINT \"Test 1: PIT Timer Interrupts\"",
            "",
            "# Configure PIT to interrupt every 100 cycles on IRQ 0",
            "PITCFG 100 0",
            "",
            "# Initialize counter",
            "LPUT 0 r8_10    # Timer interrupt count",
            "",
            "# Run for a while to let timer fire",
            "HPUT 0 r16_20",
            "wait_timer:",
            "    HUADD 1 r16_20",
            "    HCMP 500 r16_20",
            "    JL wait_timer",
            "",
            "PRINT \"Timer test complete\"",
            "PRINT \"Timer interrupts received:\"",
            "PRINT r8_10",
            "",
            "# Stop timer",
            "PITSTOP",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 2: Keyboard Interrupts",
            "# ============================================",
            "PRINT \"Test 2: Keyboard Interrupts\"",
            "",
            "# Configure keyboard: IRQ 1, 50 cycle delay between keys",
            "KBDCFG 1 50",
            "",
            "# Simulate key presses",
            "KBDPUSH 0x1E    # 'A' key scancode",
            "KBDPUSH 0x30    # 'B' key scancode",
            "KBDPUSH 0x2E    # 'C' key scancode",
            "",
            "PRINT \"Queued 3 key presses (A, B, C)\"",
            "",
            "# Initialize counter",
            "LPUT 0 r8_11    # Keyboard interrupt count",
            "",
            "# Wait for keys to process",
            "HPUT 0 r16_21",
            "wait_kbd:",
            "    HUADD 1 r16_21",
            "    HCMP 300 r16_21",
            "    JL wait_kbd",
            "",
            "PRINT \"Keyboard interrupts received:\"",
            "PRINT r8_11",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 3: Serial Port Interrupts",
            "# ============================================",
            "PRINT \"Test 3: Serial Port Interrupts\"",
            "",
            "# Configure COM1: IRQ 4, 100 cycle baud delay",
            "SERIALCFG 0 4 100",
            "",
            "# Initialize counter",
            "LPUT 0 r8_12    # Serial TX interrupt count",
            "",
            "# Transmit some bytes",
            "SERIALTX 0 0x48   # 'H'",
            "SERIALTX 0 0x69   # 'i'",
            "SERIALTX 0 0x21   # '!'",
            "",
            "PRINT \"Queued serial transmission\"",
            "",
            "# Wait for transmission",
            "HPUT 0 r16_22",
            "wait_serial:",
            "    HUADD 1 r16_22",
            "    HCMP 500 r16_22",
            "    JL wait_serial",
            "",
            "PRINT \"Serial TX interrupts received:\"",
            "PRINT r8_12",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 4: Disk Controller Interrupts",
            "# ============================================",
            "PRINT \"Test 4: Disk Controller Interrupts\"",
            "",
            "# Configure disk: IRQ 14, 200 cycle operation delay",
            "DISKCFG 14 200",
            "",
            "# Initialize counter",
            "LPUT 0 r8_13    # Disk interrupt count",
            "",
            "# Start disk operation",
            "DISKCMD 200",
            "PRINT \"Disk read operation started\"",
            "",
            "# Wait for disk",
            "HPUT 0 r16_23",
            "wait_disk:",
            "    HUADD 1 r16_23",
            "    HCMP 300 r16_23",
            "    JL wait_disk",
            "",
            "PRINT \"Disk interrupts received:\"",
            "PRINT r8_13",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 5: RTC Periodic Interrupts",
            "# ============================================",
            "PRINT \"Test 5: RTC Periodic Interrupts\"",
            "",
            "# Configure RTC: IRQ 8, interrupt every 128 cycles",
            "RTCCFG 8 128",
            "",
            "# Initialize counter",
            "LPUT 0 r8_14    # RTC interrupt count",
            "",
            "# Wait for RTC ticks",
            "HPUT 0 r16_24",
            "wait_rtc:",
            "    HUADD 1 r16_24",
            "    HCMP 600 r16_24",
            "    JL wait_rtc",
            "",
            "PRINT \"RTC interrupts received:\"",
            "PRINT r8_14",
            "",
            "# Stop RTC",
            "RTCSTOP",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 6: Custom Hardware Device",
            "# ============================================",
            "PRINT \"Test 6: Custom Hardware Device\"",
            "",
            "# Configure custom device:",
            "# Device 0, IRQ 10, fire after 150 cycles, periodic every 200 cycles",
            "HWDEV 0 10 150 200 CustomSensor",
            "",
            "# Initialize counter",
            "LPUT 0 r8_15    # Custom device interrupt count",
            "",
            "# Wait for custom device",
            "HPUT 0 r16_25",
            "wait_custom:",
            "    HUADD 1 r16_25",
            "    HCMP 800 r16_25",
            "    JL wait_custom",
            "",
            "PRINT \"Custom device interrupts received:\"",
            "PRINT r8_15",
            "",
            "# Disable custom device",
            "HWDIS 0",
            "PRINT \"\"",
            "",
            "# ============================================",
            "# Test 7: Mixed Interrupt Load",
            "# ============================================",
            "PRINT \"Test 7: Mixed Interrupt Load (all devices active)\"",
            "",
            "# Reset all counters",
            "LPUT 0 r8_10",
            "LPUT 0 r8_11",
            "LPUT 0 r8_12",
            "LPUT 0 r8_13",
            "LPUT 0 r8_14",
            "LPUT 0 r8_15",
            "",
            "# Re-enable all devices",
            "PITSTART",
            "RTCCFG 8 128",
            "HWDEV 1 10 100 150 MixedDevice",
            "",
            "# Queue operations",
            "KBDPUSH 0x1C",
            "SERIALTX 0 0x58",
            "DISKCMD 250",
            "",
            "PRINT \"All devices active, running for 1000 cycles...\"",
            "",
            "# Run for extended period",
            "HPUT 0 r16_26",
            "mixed_test:",
            "    HUADD 1 r16_26",
            "    HCMP 1000 r16_26",
            "    JL mixed_test",
            "",
            "PRINT \"Mixed test complete. Interrupt counts:\"",
            "PRINT \"  Timer (IRQ 0):\"",
            "PRINT r8_10",
            "PRINT \"  Keyboard (IRQ 1):\"",
            "PRINT r8_11",
            "PRINT \"  Serial (IRQ 4):\"",
            "PRINT r8_12",
            "PRINT \"  Disk (IRQ 14):\"",
            "PRINT r8_13",
            "PRINT \"  RTC (IRQ 8):\"",
            "PRINT r8_14",
            "PRINT \"  Custom (IRQ 10):\"",
            "PRINT r8_15",
            "",
            "# Clean up",
            "PITSTOP",
            "RTCSTOP",
            "HWDIS 1",
            "",
            "PRINT \"\"",
            "PRINT \"=== All hardware interrupt tests completed! ===\"",
            "",
            "# Jump to end",
            "JMP test_end",
            "",
            "# ============================================",
            "# Interrupt Handlers",
            "# ============================================",
            "",
            "timer_handler:",
            "    # Increment timer counter",
            "    LUADD 1 r8_10",
            "    IRET",
            "",
            "keyboard_handler:",
            "    # Increment keyboard counter",
            "    LUADD 1 r8_11",
            "    IRET",
            "",
            "serial_handler:",
            "    # Increment serial counter",
            "    LUADD 1 r8_12",
            "    IRET",
            "",
            "disk_handler:",
            "    # Increment disk counter",
            "    LUADD 1 r8_13",
            "    IRET",
            "",
            "rtc_handler:",
            "    # Increment RTC counter",
            "    LUADD 1 r8_14",
            "    IRET",
            "",
            "custom_device_handler:",
            "    # Increment custom device counter",
            "    LUADD 1 r8_15",
            "    IRET",
            "",
            "test_end:",
            "PRINT \"\"",
            "PRINT \"Summary:\"",
            "PRINT \"  [✓] PIT timer interrupts working\"",
            "PRINT \"  [✓] Keyboard interrupts working\"",
            "PRINT \"  [✓] Serial port interrupts working\"",
            "PRINT \"  [✓] Disk controller interrupts working\"",
            "PRINT \"  [✓] RTC periodic interrupts working\"",
            "PRINT \"  [✓] Custom device interrupts working\"",
            "PRINT \"  [✓] Priority-based interrupt handling\"",
            "PRINT \"  [✓] Multiple concurrent interrupt sources\"",
            "",
            "QUIT",
        };
        
        cpu.load_program_lines(hardware_interrupt_test);
        cpu.run();
        
        cout << "\n=== Test completed successfully! ===\n";
        
    } catch (const exception& e) {
        cerr << "Error: " << e.what() << endl;
        return 1;
    }
    
    return 0;
}