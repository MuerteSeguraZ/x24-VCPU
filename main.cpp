#include "vcpu.cpp"

int main() {
    try {
        CPU cpu(65536, 8192, 256);

        int ram8_base = cpu.mem_size - cpu.ram8_size;

        vector<string> prog = {
            "PRINT \"[BOOT] Testing XBTS/IBTS (80386 early stepping instructions)\"",
            "",
            "# --- Test XBTS (Extract Bit String) ---",
            "PRINT \"\\n=== Testing XBTS ===\"",
            "",
            "# Extract lower 4 bits from 8-bit register",
            "LOADI 0xAB r8_0",              // 10101011",
            "PRINT \"Source value: 0xAB (171)\"",
            "XBTS r8_0 0 r8_1 4",            // Extract bits 0-3 (4 bits)",
            "PRINT \"XBTS [0:3]: r8_1=\"",
            "PRINT r8_1",                    // Should be 11 (0b1011)",
            "",
            "# Extract upper 4 bits from 8-bit register",
            "LOADI 0xAB r8_2",              // 10101011",
            "XBTS r8_2 4 r8_3 4",            // Extract bits 4-7",
            "PRINT \"XBTS [4:7]: r8_3=\"",
            "PRINT r8_3",                    // Should be 10 (0b1010)",
            "",
            "# Extract middle bits",
            "LOADI 0xFF r8_4",              // 11111111",
            "XBTS r8_4 2 r8_5 3",            // Extract 3 bits starting at bit 2",
            "PRINT \"XBTS [2:4] from 0xFF: r8_5=\"",
            "PRINT r8_5",                    // Should be 7 (0b111)",
            "",
            "# Extract from 16-bit register",
            "LOADI 0xABCD r16_0",           // 1010101111001101",
            "PRINT \"Source 16-bit: 0xABCD (43981)\"",
            "XBTS r16_0 0 r16_1 8",          // Extract lower byte",
            "PRINT \"XBTS lower byte: r16_1=\"",
            "PRINT r16_1",                   // Should be 205 (0xCD)",
            "",
            "XBTS r16_0 8 r16_2 8",          // Extract upper byte",
            "PRINT \"XBTS upper byte: r16_2=\"",
            "PRINT r16_2",                   // Should be 171 (0xAB)",
            "",
            "# Extract with register offset",
            "LOADI 0xF0 r8_6",              // 11110000",
            "LOADI 4 r8_7",                  // Offset in register",
            "XBTS r8_6 r8_7 r8_8 4",         // Extract 4 bits from offset 4",
            "PRINT \"XBTS with register offset: r8_8=\"",
            "PRINT r8_8",                    // Should be 15 (0b1111)",
            "",
            "# --- Test IBTS (Insert Bit String) ---",
            "PRINT \"\\n=== Testing IBTS ===\"",
            "",
            "# Insert into lower 4 bits",
            "LOADI 0xFF r8_9",               // 11111111 (destination)",
            "LOADI 0x00 r8_10",              // 00000000 (source)",
            "PRINT \"Before IBTS: r8_9=\"",
            "PRINT r8_9",                    // Should be 255",
            "IBTS r8_9 0 r8_10 4",           // Insert 0000 into bits 0-3",
            "PRINT \"After IBTS [0:3]=0: r8_9=\"",
            "PRINT r8_9",                    // Should be 240 (0b11110000)",
            "",
            "# Insert into upper 4 bits",
            "LOADI 0x00 r8_11",              // 00000000",
            "LOADI 0x0F r8_12",              // 00001111 (source)",
            "IBTS r8_11 4 r8_12 4",          // Insert 1111 into bits 4-7",
            "PRINT \"IBTS [4:7]=0xF: r8_11=\"",
            "PRINT r8_11",                   // Should be 240 (0b11110000)",
            "",
            "# Insert middle bits",
            "LOADI 0x00 r8_13",              // 00000000",
            "LOADI 0x07 r8_14",              // 00000111",
            "IBTS r8_13 2 r8_14 3",          // Insert 111 into bits 2-4",
            "PRINT \"IBTS [2:4]=0x7: r8_13=\"",
            "PRINT r8_13",                   // Should be 28 (0b00011100)",
            "",
            "# Create a bit pattern by inserting",
            "LOADI 0 r8_15",                 // Start with 0",
            "LOADI 5 r8_16",                 // Value to insert (0b101)",
            "IBTS r8_15 0 r8_16 3",          // Insert into lower 3 bits",
            "PRINT \"Pattern building step 1: r8_15=\"",
            "PRINT r8_15",                   // Should be 5 (0b00000101)",
            "LOADI 3 r8_17",                 // Next value (0b11)",
            "IBTS r8_15 3 r8_17 2",          // Insert into bits 3-4",
            "PRINT \"Pattern building step 2: r8_15=\"",
            "PRINT r8_15",                   // Should be 29 (0b00011101)",
            "",
            "# 16-bit insert",
            "LOADI 0 r16_3",                 // Start with 0",
            "LOADI 0xFF r16_4",              // Insert 0xFF",
            "IBTS r16_3 4 r16_4 8",          // Insert byte at offset 4",
            "PRINT \"16-bit IBTS: r16_3=\"",
            "PRINT r16_3",                   // Should be 4080 (0x0FF0)",
            "",
            "# Combining XBTS and IBTS - swap nibbles",
            "PRINT \"\\n=== Nibble Swap with XBTS+IBTS ===\"",
            "LOADI 0x3C r8_18",              // 00111100",
            "PRINT \"Original: r8_18=\"",
            "PRINT r8_18",                   // Should be 60",
            "",
            "# Extract lower nibble",
            "XBTS r8_18 0 r8_19 4",
            "# Extract upper nibble",
            "XBTS r8_18 4 r8_20 4",
            "# Clear original",
            "LOADI 0 r8_18",
            "# Insert in swapped positions",
            "IBTS r8_18 4 r8_19 4",          // Lower -> Upper",
            "IBTS r8_18 0 r8_20 4",          // Upper -> Lower",
            "PRINT \"After nibble swap: r8_18=\"",
            "PRINT r8_18",                   // Should be 195 (0b11000011)",
            "",
            "# --- Test XCHG ---",
            "PRINT \"\\n=== Testing XCHG ===\"",
            "",
            "# Exchange two 8-bit registers",
            "LOADI 10 r8_21",
            "LOADI 20 r8_22",
            "PRINT \"Before XCHG: r8_21=\"",
            "PRINT r8_21",
            "PRINT \"Before XCHG: r8_22=\"",
            "PRINT r8_22",
            "XCHG r8_21 r8_22",
            "PRINT \"After XCHG: r8_21=\"",
            "PRINT r8_21",
            "PRINT \"After XCHG: r8_22=\"",
            "PRINT r8_22",
            "",
            "# Exchange two 16-bit registers",
            "LOADI 1000 r16_5",
            "LOADI 2000 r16_6",
            "PRINT \"Before XCHG: r16_5=\"",
            "PRINT r16_5",
            "PRINT \"Before XCHG: r16_6=\"",
            "PRINT r16_6",
            "XCHG r16_5 r16_6",
            "PRINT \"After XCHG: r16_5=\"",
            "PRINT r16_5",
            "PRINT \"After XCHG: r16_6=\"",
            "PRINT r16_6",
            "",
            "PRINT \"\\n[BOOT] All tests completed!\"",
            "QUIT"
        };

        cpu.load_program_lines(prog);
        cpu.run();

    } catch (const exception &ex) {
        cerr << "Runtime error: " << ex.what() << "\n";
        return 2;
    }
    return 0;
}