#include <iostream>
#include <vector>
#include <string>
#include "vcpu.cpp"

using namespace std;

int main() {
    try {
        CPU cpu;
        
        vector<string> test_program = {
    "# STORE and HSTORE Test Program",
    "",
    "# Test 1: Basic STORE with register source and immediate address",
    "PRINT \"Test 1: STORE r8_0, 0x1000\"",
    "MOV 0xAA r8_0",
    "STORE r8_0 0x1000",
    "MOV [0x1000] r8_1",
    "PRINT \"Stored value (should be 170): \"",
    "PRINT r8_1",
    "",
    "# Test 2: STORE with immediate source and immediate address",
    "PRINT \"\\nTest 2: STORE 0x55, 0x2000\"",
    "STORE 0x55 0x2000",
    "MOV [0x2000] r8_2",
    "PRINT \"Stored value (should be 85): \"",
    "PRINT r8_2",
    "",
    "# Test 3: STORE with register source and register address",
    "PRINT \"\\nTest 3: STORE r8_3, r16_0 (address in register)\"",
    "MOV 0x3000 r16_0",
    "MOV 0x77 r8_3",
    "STORE r8_3 r16_0",
    "MOV [0x3000] r8_4",
    "PRINT \"Stored value (should be 119): \"",
    "PRINT r8_4",
    "",
    "# Test 4: STORE with immediate source and register address",
    "PRINT \"\\nTest 4: STORE 0xBB, r16_1\"",
    "MOV 0x4000 r16_1",
    "STORE 0xBB r16_1",
    "MOV [0x4000] r8_5",
    "PRINT \"Stored value (should be 187): \"",
    "PRINT r8_5",
    "",
    "# Test 5: STORE using indexed addressing [r16_N]",
    "PRINT \"\\nTest 5: STORE 0xCC, [r16_2]\"",
    "MOV 0x5000 r16_2",
    "STORE 0xCC [r16_2]",
    "MOV [r16_2] r8_6",
    "PRINT \"Stored value (should be 204): \"",
    "PRINT r8_6",
    "",
    "# Test 6: Basic HSTORE with register source and immediate address",
    "PRINT \"\\nTest 6: HSTORE r16_3, 0x6000\"",
    "MOV 0x1234 r16_3",
    "HSTORE r16_3 0x6000",
    "MOV [0x6000] r16_4",
    "PRINT \"Stored value (should be 4660): \"",
    "PRINT r16_4",
    "",
    "# Test 7: HSTORE with immediate source and immediate address",
    "PRINT \"\\nTest 7: HSTORE 0xABCD, 0x7000\"",
    "HSTORE 0xABCD 0x7000",
    "MOV [0x7000] r16_5",
    "PRINT \"Stored value (should be 43981): \"",
    "PRINT r16_5",
    "",
    "# Test 8: HSTORE with register source and register address",
    "PRINT \"\\nTest 8: HSTORE r16_6, r16_7 (address in register)\"",
    "MOV 0x8000 r16_7",
    "MOV 0x5678 r16_6",
    "HSTORE r16_6 r16_7",
    "MOV [0x8000] r16_8",
    "PRINT \"Stored value (should be 22136): \"",
    "PRINT r16_8",
    "",
    "# Test 9: HSTORE with immediate source and register address",
    "PRINT \"\\nTest 9: HSTORE 0xBEEF, r16_9\"",
    "MOV 0x9000 r16_9",
    "HSTORE 0xBEEF r16_9",
    "MOV [0x9000] r16_10",
    "PRINT \"Stored value (should be 48879): \"",
    "PRINT r16_10",
    "",
    "# Test 10: HSTORE using indexed addressing [r16_N]",
    "PRINT \"\\nTest 10: HSTORE 0xCAFE, [r16_11]\"",
    "MOV 0xA000 r16_11",
    "HSTORE 0xCAFE [r16_11]",
    "MOV [r16_11] r16_12",
    "PRINT \"Stored value (should be 51966): \"",
    "PRINT r16_12",
    "",
    "# Test 11: Sequential STORE operations",
    "PRINT \"\\nTest 11: Sequential STORE to adjacent addresses\"",
    "STORE 0x11 0xB000",
    "STORE 0x22 0xB001",
    "STORE 0x33 0xB002",
    "STORE 0x44 0xB003",
    "MOV [0xB000] r8_7",
    "MOV [0xB001] r8_8",
    "MOV [0xB002] r8_9",
    "MOV [0xB003] r8_10",
    "PRINT \"Byte 0 (should be 17): \"",
    "PRINT r8_7",
    "PRINT \"Byte 1 (should be 34): \"",
    "PRINT r8_8",
    "PRINT \"Byte 2 (should be 51): \"",
    "PRINT r8_9",
    "PRINT \"Byte 3 (should be 68): \"",
    "PRINT r8_10",
    "",
    "# Test 12: Sequential HSTORE operations",
    "PRINT \"\\nTest 12: Sequential HSTORE to adjacent addresses\"",
    "HSTORE 0x1111 0xC000",
    "HSTORE 0x2222 0xC002",
    "HSTORE 0x3333 0xC004",
    "MOV [0xC000] r16_13",
    "MOV [0xC002] r16_14",
    "MOV [0xC004] r16_15",
    "PRINT \"Word 0 (should be 4369): \"",
    "PRINT r16_13",
    "PRINT \"Word 1 (should be 8738): \"",
    "PRINT r16_14",
    "PRINT \"Word 2 (should be 13107): \"",
    "PRINT r16_15",
    "",
    "# Test 13: Overwrite test - STORE then HSTORE at same location",
    "PRINT \"\\nTest 13: Overwrite with HSTORE\"",
    "STORE 0xFF 0xD000",
    "STORE 0xFF 0xD001",
    "HSTORE 0x0000 0xD000",
    "MOV [0xD000] r16_16",
    "PRINT \"After overwrite (should be 0): \"",
    "PRINT r16_16",
    "",
    "# Test 14: Store using computed addresses",
    "PRINT \"\\nTest 14: Store using computed addresses\"",
    "MOV 0xE000 r16_17",
    "MOV 0x10 r8_11",
    "STORE r8_11 r16_17",
    "HUADD 1 r16_17",
    "MOV 0x20 r8_11",
    "STORE r8_11 r16_17",
    "HUADD 1 r16_17",
    "MOV 0x30 r8_11",
    "STORE r8_11 r16_17",
    "MOV [0xE000] r8_12",
    "MOV [0xE001] r8_13",
    "MOV [0xE002] r8_14",
    "PRINT \"First byte (should be 16): \"",
    "PRINT r8_12",
    "PRINT \"Second byte (should be 32): \"",
    "PRINT r8_13",
    "PRINT \"Third byte (should be 48): \"",
    "PRINT r8_14",
    "",
    "# Test 15: Store max values",
    "PRINT \"\\nTest 15: Store maximum values\"",
    "STORE 0xFF 0xF000",
    "HSTORE 0xFFFF 0xF100",
    "MOV [0xF000] r8_15",
    "MOV [0xF100] r16_18",
    "PRINT \"Max 8-bit (should be 255): \"",
    "PRINT r8_15",
    "PRINT \"Max 16-bit (should be 65535): \"",
    "PRINT r16_18",
    "",
    "PRINT \"\\nAll STORE and HSTORE tests completed!\"",
    "PRINT \"Verified: Immediate and register sources, various addressing modes\"",
    "EXIT"
};
        
        cpu.load_program_lines(test_program);
        cpu.run();
        
        cout << "\n=== Test completed successfully! ===\n";
        
    } catch (const exception& e) {
        cerr << "Error: " << e.what() << endl;
        return 1;
    }
    
    return 0;
}